using System;
using Stump.ORM;
using Stump.ORM.SubSonic.SQLGeneration.Schema;
using Stump.Server.WorldServer.Game.Actors.RolePlay.Monsters;
using Stump.DofusProtocol.D2oClasses.Tools.D2o;
using Stump.Server.WorldServer.Game.Actors.RolePlay.Characters;
using ConditionExpression = Stump.Server.WorldServer.Game.Conditions.ConditionExpression;

namespace Stump.Server.WorldServer.Database.Monsters
{
    public class DroppableItemRelator
    {
        public static string FetchQuery = "SELECT * FROM monsters_drops";
        public static string FetchByOwner = "SELECT * FROM monsters_drops WHERE MonsterOwnerId = {0}";
    }

    [TableName("monsters_drops")]
    [D2OClass("MonsterDrop", "com.ankamagames.dofus.datacenter.monsters")]
    public class DroppableItem : IAssignedByD2O, IAutoGeneratedRecord
    {
        private string m_DropCondition;
        private ConditionExpression m_DropConditionExpression;
        private MonsterTemplate m_template;

        public int Id { get; set; }

        [NullString]
        public string Name { get; set; }

        public int MonsterOwnerId { get; set; }

        public short ItemId { get; set; }

        [DefaultSetting(0)]
        public int DropLimit { get; set; }

        [NumericPrecision(16, 2)]
        public double DropRateForGrade1 { get; set; }

        [NumericPrecision(16, 2)]
        public double DropRateForGrade2 { get; set; }

        [NumericPrecision(16, 2)]
        public double DropRateForGrade3 { get; set; }

        [NumericPrecision(16, 2)]
        public double DropRateForGrade4 { get; set; }

        [NumericPrecision(16, 2)]
        public double DropRateForGrade5 { get; set; }

        [DefaultSetting(1)]
        public int RollsCounter { get; set; }

        [DefaultSetting(100)]
        public int ProspectingLock { get; set; }

        [NullString]
        public string DropCondition { get; set; }

        public int DropGroup { get; set; }

        public bool TaxCollectorCannotLoot { get; set; }

        public bool IsTemporisItem { get; set; }

        public bool IsEtheralItem { get; set; }

        public bool IsDisabled { get; set; }

        [Ignore]
        public MonsterTemplate MonsterOwner
        {
            get { return m_template ?? (m_template = MonsterManager.Instance.GetTemplate(MonsterOwnerId)); }
            set
            {
                m_template = value;
                MonsterOwnerId = value.Id;
            }
        }

        [Ignore]
        public ConditionExpression ConditionExpression
        {
            get
            {
                if (string.IsNullOrEmpty(DropCondition) || DropCondition == "null")
                    return null;

                return m_DropConditionExpression ?? (m_DropConditionExpression = ConditionExpression.Parse(DropCondition));
            }
            set
            {
                m_DropConditionExpression = value;
                DropCondition = value != null ? value.ToString() : null;
            }
        }

        public bool AreConditionsFilled(Character character)
        {
            try
            {
                return ConditionExpression == null || ConditionExpression.Eval(character);
            }
            catch (Exception ex)
            {
                Console.WriteLine("A general exception occurred: " + ex.Message);
                return false;
            }
        }

        public void SetDropRate(double rate)
        {
            DropRateForGrade1 = rate;
            DropRateForGrade2 = rate;
            DropRateForGrade3 = rate;
            DropRateForGrade4 = rate;
            DropRateForGrade5 = rate;
        }

        public void SetDropRate(double min, double max)
        {
            if (min > max)
                throw new ArgumentException("min > max");

            var div = max - min / 4d;

            DropRateForGrade1 = min;
            DropRateForGrade2 = min + div;
            DropRateForGrade3 = min + 2 * div;
            DropRateForGrade4 = min + 3 * div;
            DropRateForGrade5 = max;
        }

        public double GetDropRate(int grade)
        {
            if (grade <= 1)
                return DropRateForGrade1;
            else if (grade == 2)
                return DropRateForGrade2;
            else if (grade == 3)
                return DropRateForGrade3;
            else if (grade == 4)
                return DropRateForGrade4;
            else
                return DropRateForGrade5;
        }

        #region IAssignedByD2O Members
        public void AssignFields(object d2oObject)
        {
            var drop = (DofusProtocol.D2oClasses.MonsterDrop)d2oObject;
            Id = (int)drop.dropId;
            MonsterOwnerId = drop.monsterId;
            ItemId = (short)drop.objectId;
            DropLimit = drop.count;
            DropRateForGrade1 = drop.percentDropForGrade1;
            DropRateForGrade2 = drop.percentDropForGrade2;
            DropRateForGrade3 = drop.percentDropForGrade3;
            DropRateForGrade4 = drop.percentDropForGrade4;
        }
        #endregion
    }
}