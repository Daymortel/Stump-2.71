using Stump.DofusProtocol.D2oClasses;
using Stump.DofusProtocol.D2oClasses.Tools.D2o;
using Stump.DofusProtocol.Enums;
using Stump.ORM;
using Stump.ORM.SubSonic.SQLGeneration.Schema;
using Stump.Server.WorldServer.Database.I18n;
using Stump.Server.WorldServer.Game.Actors.Look;
using Stump.Server.WorldServer.Game.Actors.RolePlay.Characters;
using Stump.Server.WorldServer.Game.Guilds;
using System.Collections.Generic;

namespace Stump.Server.WorldServer.Database.Social
{
    public class EmoteRelator
    {
        public static string FetchQuery = "SELECT * FROM tinsel_emotes";
    }

    [TableName("tinsel_emotes")]
    [D2OClass("Emoticon", "com.ankamagames.dofus.datacenter.communication")]
    public class Emote : IAutoGeneratedRecord, IAssignedByD2O
    {
        private string m_name;
        private List<string> m_anims = new List<string>();
        private string m_animsCSV;

        [PrimaryKey("Id", false)]
        public uint Id { get; set; }

        public uint NameId { get; set; }

        public string Name
        {
            get { return m_name ?? (m_name = TextManager.Instance.GetText(NameId)); }
            set { m_name = value is null ? string.Empty : value; }
        }

        public uint ShortcutId { get; set; }

        public uint Order { get; set; }

        public string AnimName { get; set; }

        public bool Persistancy { get; set; }

        public bool Eight_directions { get; set; }

        public bool Aura { get; set; }

        public uint Cooldown { get; set; }

        public uint Duration { get; set; }

        public uint Weight { get; set; }

        public uint SpellLevelId { get; set; }

        public EmotesEnum EmoteId => (EmotesEnum)Id;

        public ActorLook UpdateEmoteLook(Character character, ActorLook look, bool apply)
        {
            if (apply)
            {
                return UpdateEmoteLookWithAura(character, look);
            }
            else
            {
                return UpdateEmoteLookWithoutAura(character, look);
            }
        }

        private ActorLook UpdateEmoteLookWithAura(Character character, ActorLook look) //ADD
        {
            var auraLookMap = new Dictionary<EmotesEnum, short>()
            {
                { EmotesEnum.EMOTE_AURA_DE_PUISSANCE, (character.Level >= 200 ? (short)170 : (short)169) },
                { EmotesEnum.EMOTE_AURA_VAMPYRIQUE, 171 },
                { EmotesEnum.EMOTE_AURA_BLEUTÉE_DE_L_ORNITHORYNQUE_ANCESTRAL, 1465 },
                { EmotesEnum.EMOTE_AURA_DE_NELWEEN, 1501 },
                { EmotesEnum.OMEGA_100, 4829 },
                { EmotesEnum.OMEGA_200, 4830 },
                { EmotesEnum.OMEGA_300, 4831 },
                { EmotesEnum.OMEGA_400, 4832 },
                { EmotesEnum.OMEGA_500, 4833 },
            };

            if (auraLookMap.TryGetValue(EmoteId, out var auraSkinId))
            {
                var auraLook = new ActorLook(auraSkinId);

                look.SetSubLook(new SubActorLook(0, SubEntityBindingPointCategoryEnum.HOOK_POINT_CATEGORY_BASE_FOREGROUND, auraLook));
            }

            if (EmoteId == EmotesEnum.EMOTE_GUILD || EmoteId == EmotesEnum.VICTORIOUS_GUILD_STANDARD)
            {
                if (character.Guild == null)
                    return look;

                var playerLook = look.GetRiderLook() ?? look;

                playerLook.AddSkin((short)character.Guild.Emblem.Template.SkinId);
                playerLook.AddColor(7, character.Guild.Emblem.BackgroundColor);
                playerLook.AddColor(8, character.Guild.Emblem.SymbolColor);
                playerLook.AddColor(9, character.Guild.Emblem.SymbolColor);
            }
            else if (EmoteId == EmotesEnum.EMOTE_ALLIANCE)
            {
                if (character.Guild == null && character.Guild.Alliance.Id < 1)
                    return look;

                var playerLook = look.GetRiderLook() ?? look;

                playerLook.AddSkin((short)character.Guild.Emblem.Template.SkinId);
                playerLook.AddColor(9, character.Guild.Alliance.Emblem.BackgroundColor);
                playerLook.AddColor(10, character.Guild.Alliance.Emblem.SymbolColor);
            }

            return look;
        }

        private ActorLook UpdateEmoteLookWithoutAura(Character character, ActorLook look) //REMOVE
        {
            var emotesToRemoveSublook = new List<EmotesEnum>
            {
                EmotesEnum.EMOTE_AURA_DE_PUISSANCE,
                EmotesEnum.EMOTE_AURA_VAMPYRIQUE,
                EmotesEnum.EMOTE_AURA_BLEUTÉE_DE_L_ORNITHORYNQUE_ANCESTRAL,
                EmotesEnum.OMEGA_100,
                EmotesEnum.OMEGA_200,
                EmotesEnum.OMEGA_300,
                EmotesEnum.OMEGA_400,
                EmotesEnum.OMEGA_500,
                EmotesEnum.NORRAI_S_AURA,
                EmotesEnum.MERIANA_S_AURA,
                EmotesEnum.RATATHROSK_S_AURA,
                EmotesEnum.DJAUL_S_AURA,
                EmotesEnum.SEPTANGEL_S_AURA,
                EmotesEnum.RIMANDA_S_AURA,
                EmotesEnum.EMOTE_AURA_DE_NELWEEN
            };

            if (EmoteId == EmotesEnum.EMOTE_GUILD || EmoteId == EmotesEnum.VICTORIOUS_GUILD_STANDARD)
            {
                if (character.Guild == null)
                    return look;

                var playerLook = look.GetRiderLook() ?? look;

                playerLook.RemoveSkin((short)character.Guild.Emblem.Template.SkinId);
                playerLook.RemoveColor(7);
                playerLook.RemoveColor(8);
                playerLook.RemoveColor(9);
            }
            else if (EmoteId == EmotesEnum.EMOTE_ALLIANCE)
            {
                if (character.Guild == null)
                    return look;

                var symbolShape = GuildManager.Instance.TryGetEmblem(character.Guild.Alliance.Emblem.SymbolShape);
                var playerLook = look.GetRiderLook() ?? look;

                playerLook.RemoveSkin((short)symbolShape.SkinId);
                playerLook.RemoveColor(9);
                playerLook.RemoveColor(10);
            }

            if (emotesToRemoveSublook.Contains(EmoteId))
            {
                look.RemoveSubLook(SubEntityBindingPointCategoryEnum.HOOK_POINT_CATEGORY_BASE_FOREGROUND);
            }

            return look;
        }

        public void AssignFields(object d2oObject)
        {
            var emote = (Emoticon)d2oObject;

            Id = emote.Id;
            Name = "";
            NameId = emote.NameId;
            ShortcutId = emote.ShortcutId;
            Order = emote.Order;
            AnimName = emote.AnimName;
            Persistancy = emote.Persistancy;
            Eight_directions = emote.Eight_directions;
            Aura = emote.Aura;
            Cooldown = emote.Cooldown;
            Duration = emote.Duration;
            Weight = emote.Weight;
            SpellLevelId = emote.SpellLevelId;
        }
    }
}