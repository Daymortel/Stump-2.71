using System;
using System.Linq;
using Stump.Core.Cache;
using Stump.DofusProtocol.Enums;
using Stump.DofusProtocol.Types;
using Stump.ORM;
using Stump.ORM.SubSonic.SQLGeneration.Schema;
using Stump.Server.WorldServer.Database.Items.Templates;
using Stump.Server.WorldServer.Database.Npcs.Replies;
using Stump.Server.WorldServer.Game.Actors.RolePlay.Characters;
using Stump.Server.WorldServer.Game.Conditions;
using Stump.Server.WorldServer.Game.Effects.Instances;

namespace Stump.Server.WorldServer.Database.Items.Shops
{
    public class NpcItemRelator
    {
        public static string FetchQuery = "SELECT * FROM npcs_items";

        /// <summary>
        /// Use string.Format
        /// </summary>
        public static string FetchByNpcShop = "SELECT * FROM npcs_items WHERE NpcShopId = {0}";
    }

    [TableName("npcs_items")]
    public class NpcItem : ItemToSell, IAutoGeneratedRecord
    {
        private string m_buyCriterion;
        private ConditionExpression m_criteriaExpression;
        private double? m_customPrice;

        public NpcItem()
        {
            m_objectItemToSellInNpcShop = new ObjectValidator<ObjectItemToSellInNpcShop>(BuildObjectItemToSellInNpcShop);
        }

        public int NpcShopId { get; set; }

        public int NpcTempId { get; set; }

        public double Active_Percent_Discount { get; set; }

        public DateTime Discount_Date_End { get; set; }

        public double Price
        {
            get { return CustomPrice.HasValue ? CustomPrice.Value : Item.Price; }
        }

        public double? CustomPrice
        {
            get { return m_customPrice; }
            set
            {
                m_customPrice = value;
                m_objectItemToSellInNpcShop.Invalidate();
            }
        }

        [NullString]
        public string BuyCriterion
        {
            get { return m_buyCriterion; }
            set
            {
                m_buyCriterion = value;
                m_criteriaExpression = null;
            }
        }

        [Ignore]
        public ConditionExpression CriteriaExpression
        {
            get
            {
                if (string.IsNullOrEmpty(BuyCriterion) || BuyCriterion == "null")
                    return null;

                return m_criteriaExpression ?? (m_criteriaExpression = ConditionExpression.Parse(BuyCriterion));
            }
            set
            {
                m_criteriaExpression = value;
                BuyCriterion = value.ToString();
            }
        }

        public bool AreConditionsFilled(Character character)
        {
            return CriteriaExpression == null || CriteriaExpression.Eval(character);
        }

        public bool MaxStats
        {
            get;
            set;
        }

        public string Type { get; set; }

        public short Level { get; set; }

        #region ObjectItemToSellInNpcShop

        private readonly ObjectValidator<ObjectItemToSellInNpcShop> m_objectItemToSellInNpcShop;

        private ObjectItemToSellInNpcShop BuildObjectItemToSellInNpcShop()
        {
            if (DateTime.Now <= Discount_Date_End)
            {
                //return new ObjectItemToSellInNpcShop();

                double percentual = Active_Percent_Discount;
                int finalPrice = ((int)(CustomPrice.Value - (percentual * CustomPrice.Value)));

                if (finalPrice <= 1)
                    finalPrice = 1;

                //UpdateEffects(Item);

                return new ObjectItemToSellInNpcShop((ushort)Item.Id, Item.Effects.Select(entry => entry.GetObjectEffect()).ToArray(),
                    (uint)(CustomPrice.HasValue ? finalPrice : Item.Price), BuyCriterion ?? string.Empty);
            }
            else
            {
                //UpdateEffects(Item);

                return new ObjectItemToSellInNpcShop((ushort)Item.Id, Item.Effects.Select(entry => entry.GetObjectEffect()).ToArray(),
                   (uint)(CustomPrice.HasValue ? CustomPrice.Value : Item.Price), BuyCriterion ?? string.Empty);
            }
        }

        private void UpdateEffects(ItemTemplate Item)
        {
            //#region Região Effects Temporarios
            //if (Item.Id == 30363 && DateTime.Now <= Discount_Date_End)
            //{
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_AddOrnament, (short)261));
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_Appearance, (short)13152));
            //}
            //if (Item.Id == 30364 && DateTime.Now <= Discount_Date_End)
            //{
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_AddOrnament, (short)262));
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_Appearance, (short)13152));
            //}
            //if (Item.Id == 30365 && DateTime.Now <= Discount_Date_End)
            //{
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_AddOrnament, (short)263));
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_Appearance, (short)13152));
            //}
            //if (Item.Id == 30366 && DateTime.Now <= Discount_Date_End)
            //{
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_AddOrnament, (short)264));
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_Appearance, (short)13152));
            //}
            //#endregion

            //#region Região Remove Effects
            //if (Item.Effects.Exists(x => x.EffectId == EffectsEnum.Effect_Exchangeable))
            //{
            //    Item.Effects.RemoveAll(x => x.EffectId == EffectsEnum.Effect_Exchangeable);
            //}
            //if (Item.Effects.Exists(x => x.EffectId == EffectsEnum.Effect_LastMealDate))
            //{
            //    Item.Effects.RemoveAll(x => x.EffectId == EffectsEnum.Effect_LastMealDate);
            //}
            //#endregion

            //#region Região Adiciona Effects
            //if (Item.Effects.Exists(x => x.EffectId == EffectsEnum.Effect_Compatible))
            //{
            //    var EffectTemplaId = (Item.Effects.FirstOrDefault(x => x.EffectId == EffectsEnum.Effect_Compatible) as EffectInteger).Value;
            //    Item.Effects.RemoveAll(x => x.EffectId == EffectsEnum.Effect_Compatible);
            //    Item.Effects.Add(new EffectInteger(EffectsEnum.Effect_Compatible, (short)EffectTemplaId));
            //}
            //#endregion
        }

        public override Item GetNetworkItem()
        {
            return m_objectItemToSellInNpcShop;
        }

        #endregion
    }
}