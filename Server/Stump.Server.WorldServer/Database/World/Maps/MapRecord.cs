using System;
using Stump.Core.IO;
using Stump.ORM;
using Stump.ORM.SubSonic.SQLGeneration.Schema;

namespace Stump.Server.WorldServer.Database.World.Maps
{
    public class MapRecordRelator
    {
        public static string FetchQuery = "SELECT * FROM world_maps " +
                                          "INNER JOIN world_maps_positions ON world_maps_positions.Id = world_maps.Id";

        public MapRecord Map(MapRecord map, MapPositionRecord position)
        {
            map.Position = position;
            position.Map = map;
            return map;
        }
    }

    [TableName("world_maps")]
    public class MapRecord : ISaveIntercepter, IAutoGeneratedRecord
    {
        private short[] m_blueCells;
        private byte[] m_compressedCells;
        private short[] m_redCells;

        [PrimaryKey("Id", false)]
        public long Id
        {
            get;
            set;
        }

        /// <summary>
        ///   Map version of this map.
        /// </summary>
        public uint Version
        {
            get;
            set;
        }

        /// <summary>
        ///   Relative id of this map.
        /// </summary>
        public long RelativeId
        {
            get;
            set;
        }

        /// <summary>
        ///   Type of this map.
        /// </summary>
        public int MapType
        {
            get;
            set;
        }

        /// <summary>
        ///   Zone Id which owns this map.
        /// </summary>
        public int SubAreaId
        {
            get;
            set;
        }

        [Ignore]
        public MapPositionRecord Position
        {
            get;
            set;
        }

        [Ignore]
        public bool Outdoor
        {
            get { return Position != null && Position.Outdoor; }
            set { if (Position != null) Position.Outdoor = value; }
        }

        public long TopNeighbourId
        {
            get;
            set;
        }

        public long BottomNeighbourId
        {
            get;
            set;
        }

        public long LeftNeighbourId
        {
            get;
            set;
        }

        public long RightNeighbourId
        {
            get;
            set;
        }

        public short? TopNeighbourCellId
        {
            get;
            set;
        }

        public short? BottomNeighbourCellId
        {
            get;
            set;
        }

        public short? LeftNeighbourCellId
        {
            get;
            set;
        }

        public short? RightNeighbourCellId
        {
            get;
            set;
        }

        public long ClientTopNeighbourId
        {
            get;
            set;
        }

        public long ClientBottomNeighbourId
        {
            get;
            set;
        }

        public long ClientLeftNeighbourId
        {
            get;
            set;
        }

        public long ClientRightNeighbourId
        {
            get;
            set;
        }

        public long ShadowBonusOnEntities
        {
            get;
            set;
        }

        public bool UseLowpassFilter
        {
            get;
            set;
        }

        public bool UseReverb
        {
            get;
            set;
        }

        public int PresetId
        {
            get;
            set;
        }

        [NullString]
        public string BlueCellsCSV
        {
            get;
            set;
        }

        [NullString]
        public string RedCellsCSV
        {
            get;
            set;
        }

        public byte[] BlueCellsBin
        {
            get;
            set;
        }

        public byte[] RedCellsBin
        {
            get;
            set;
        }

        [Ignore]
        public short[] BlueFightCells
        {
            get
            {
                //return BlueCellsBin == null
                //          ? new short[0]
                //          : (m_blueCells ?? (m_blueCells = DeserializeFightCells(BlueCellsBin)));

                return BlueCellsCSV == null
                           ? BlueCellsBin == null
                          ? new short[0]
                          : (m_blueCells ?? (m_blueCells = DeserializeFightCells(BlueCellsBin)))
                           : (m_blueCells ?? (m_blueCells = BlueCellsCSV.FromCSV<short>(",")));
            }
            set
            {
                m_blueCells = value;
                BlueCellsCSV = value?.ToCSV(",");
            }
        }

        [Ignore]
        public short[] RedFightCells
        {
            get
            {
                //return RedCellsBin == null
                //          ? new short[0]
                //          : (m_redCells ?? (m_redCells = DeserializeFightCells(RedCellsBin)));
                return RedCellsCSV == null
                          ? RedCellsBin == null
                          ? new short[0]
                          : (m_redCells ?? (m_redCells = DeserializeFightCells(RedCellsBin)))
                           : (m_redCells ?? (m_redCells = RedCellsCSV.FromCSV<short>(",")));
            }
            set
            {
                m_redCells = value;
                RedCellsCSV = value?.ToCSV(",");
            }
        }

        public byte[] CompressedCells
        {
            get { return m_compressedCells; }
            set
            {
                m_compressedCells = value;
                byte[] uncompressedCells = ZipHelper.Uncompress(m_compressedCells);

                Cells = new Cell[uncompressedCells.Length / Cell.StructSize];
                for (int i = 0, j = 0; i < uncompressedCells.Length; i += Cell.StructSize, j++)
                {
                    Cells[j] = new Cell((int)this.Version);
                    Cells[j].Deserialize(uncompressedCells, i);
                }
            }
        }

        [Ignore]
        public Cell[] Cells
        {
            get;
            set;
        }

        public bool MerchantsDisabled
        {
            get;
            set;
        }

        public bool SpawnDisabled
        {
            get;
            set;
        }

        public bool IsInstantiated
        {
            get;
            set;
        }

        #region ISaveIntercepter Members

        public void BeforeSave(bool insert)
        {
            m_compressedCells = new byte[Cells.Length * Cell.StructSize];

            for (int i = 0; i < Cells.Length; i++)
            {
                Array.Copy(Cells[i].Serialize(), 0, m_compressedCells, i * Cell.StructSize, Cell.StructSize);
            }

            m_compressedCells = ZipHelper.Compress(m_compressedCells);
        }

        #endregion

        public static short[] DeserializeFightCells(byte[] bytes)
        {
            if ((bytes.Length % 2) != 0)
                throw new ArgumentException("bytes.Length % 2 != 0");

            var cells = new short[bytes.Length / 2];

            for (int i = 0, j = 0; i < bytes.Length; i += 2, j++)
                cells[j] = (short)(bytes[i] << 8 | bytes[i + 1]);

            return cells;
        }
    }
}